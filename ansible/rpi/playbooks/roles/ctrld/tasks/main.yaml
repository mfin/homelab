- name: Download ctrld archive from Github Releases
  ansible.builtin.get_url:
    url: https://github.com/Control-D-Inc/ctrld/releases/download/{{ ctrld_version }}/ctrld_{{ ctrld_version | regex_replace('^v','') }}_linux_arm64.tar.gz
    dest: /tmp/ctrld_{{ coredns_version }}_linux_arm64.tgz

- name: Extract ctrld archive
  ansible.builtin.unarchive:
    src: /tmp/ctrld_{{ coredns_version }}_linux_arm64.tgz
    dest: /usr/local/bin
    extra_opts: [--strip-components=1]
    remote_src: true
    mode: 0755
  notify: Restart ctrld

- name: Create ctrld systemd service file
  ansible.builtin.template:
    src: templates/ctrld.service.j2
    dest: /etc/systemd/system/ctrld.service
  notify: Restart ctrld

- name: Create ctrld configuration file
  ansible.builtin.template:
    src: templates/config.toml.j2
    dest: /var/lib/ctrld/config.toml
  notify: Restart ctrld

- name: Enable and start ctrld service
  ansible.builtin.systemd:
    name: ctrld
    state: started
    enabled: true
