---
version: '3'

tasks:
  template:
    desc: Template Helm chart in $app directory
    dir: '{{.app}}'
    silent: true
    env:
      HELM_SECRETS_IGNORE_MISSING_VALUES: 'true'
    vars:
      app: '{{.app | default .USER_WORKING_DIR}}'
      namespace: '{{.namespace | default (base .app)}}'
      name: '{{.name | default (base .app)}}'
    cmds:
      - helm template --dependency-update --include-crds --namespace {{.namespace}} {{.name}} . -f secrets://secrets.yaml

  apply:
    desc: Apply Helm chart from $app directory
    dir: '{{.app}}'
    silent: true
    env:
      HELM_SECRETS_IGNORE_MISSING_VALUES: 'true'
    vars:
      app: '{{.app | default .USER_WORKING_DIR}}'
      namespace: '{{.namespace | default (base .app)}}'
      name: '{{.name | default (base .app)}}'
    cmds:
      - helm template --dependency-update --include-crds --namespace {{.namespace}} {{.name}} . -f secrets://secrets.yaml | kubectl apply -n {{.namespace}} -f -

  create-namespace:
    desc: Create K8s namespace with name $namespace
    silent: true
    vars:
      namespace: '{{.namespace | default "default"}}'
    cmds:
      - kubectl create namespace {{.namespace}} --dry-run=client --output=yaml | kubectl apply -f -
